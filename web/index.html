<!doctype html>
<html lang="fr" style="color-scheme: dark;">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Coach</title>
  <style>
    :root{
      --bg:#0b0b0e;--panel:#121217;--muted:#6b7280;--text:#e5e7eb;--accent:#4f46e5;--accent-2:#22d3ee;
      --me:#1f2937;--them:#0d9488;--radius:16px;--radius-sm:12px;
      --card-bg: rgba(18,18,23,.9);--card-shadow: 0 8px 25px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0a0a0d 0%,#0b0b0e 100%);color:var(--text);
      font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui;
      display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .app{
      width:100%;max-width:800px;background:rgba(18,18,23,.8);backdrop-filter: blur(8px);
      border:1px solid #1f2430;border-radius:24px;box-shadow:0 15px 35px rgba(0,0,0,.4);
      overflow:hidden;display:flex;flex-direction:column;min-height:80vh;
    }

    /* Cartes superpos√©es */
    .cards-container {
      flex:1;display:flex;align-items:center;justify-content:center;padding:20px;
      position:relative;perspective:1000px;
      gap: 20px; /* Espacement entre les cartes */
    }

    .card {
      position:relative; /* Chang√© de absolute √† relative */
      width:280px;height:380px;background:var(--card-bg);
      border-radius:20px;border:1px solid #1f2430;box-shadow:var(--card-shadow);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      cursor:pointer;transition:all 0.3s ease;backdrop-filter:blur(10px);
      transform-style:preserve-3d;
      z-index: 1; /* z-index de base */
    }

    .card:hover {
      transform:translateY(-10px) scale(1.05);
      box-shadow:0 20px 40px rgba(0,0,0,.5);
      z-index: 5;
    }

    .card.active {
      z-index:10;
      transform: scale(1.1);
      box-shadow: 0 30px 60px rgba(0,0,0,.8);
      filter: brightness(1.1);
    }

    /* Supprimer les positionnements individuels */
    .card:nth-child(1), .card:nth-child(2), .card:nth-child(3) {
      transform: none;
      z-index: 1;
    }

    .card-icon {
      font-size:48px;margin-bottom:16px;opacity:0.8;
    }

    .card-title {
      font-size:24px;font-weight:700;margin-bottom:8px;text-align:center;
    }

    .card-desc {
      font-size:14px;color:var(--muted);text-align:center;padding:0 20px;
      line-height:1.4;
    }

    /* Animation d'entr√©e */
    .card {
      animation:cardEnter 0.6s ease-out forwards;
    }

    .card:nth-child(1) { animation-delay:0.1s; }
    .card:nth-child(2) { animation-delay:0.2s; }
    .card:nth-child(3) { animation-delay:0.3s; }

    @keyframes cardEnter {
      from {
        opacity:0;
        transform:rotate(0deg) translateY(50px) scale(0.8);
      }
      to {
        opacity:1;
        transform:rotate(var(--rotation, 0deg)) translateX(var(--translateX, 0px)) translateY(0px) scale(1);
      }
    }

    /* Interface s√©lectionn√©e */
    .interface-container {
      flex:1;display:flex;flex-direction:column;
    }

    .interface-header {
      padding:20px;text-align:center;border-bottom:1px solid #1f2430;
    }

    .interface-title {
      font-size:28px;font-weight:700;margin-bottom:8px;
    }

    .interface-subtitle {
      color:var(--muted);font-size:16px;
    }

    .back-btn {
      position:absolute;top:20px;left:20px;background:#0f0f14;border:1px solid #222739;
      border-radius:12px;color:var(--text);padding:8px 12px;cursor:pointer;
      font-size:14px;transition:all 0.2s ease;
    }

    .back-btn:hover {
      background:#1a1a1f;
    }

    .chat-container {
      flex:1;display:flex;flex-direction:column;
    }

    .scroll{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
    .bubble{
      max-width:86%;padding:12px 16px;border-radius:16px;position:relative;
      white-space:pre-wrap;word-wrap:break-word
    }
    .bubble.me{align-self:flex-end;background:var(--me);border-top-right-radius:6px}
    .bubble.ai{align-self:flex-start;background:var(--them);border-top-left-radius:6px}

    .panel{padding:16px;border-top:1px solid #1f2430;background:var(--panel)}
    textarea{
      width:100%;min-height:80px;max-height:30vh;resize:vertical;background:#0f0f14;
      border:1px solid #222739;border-radius:14px;color:var(--text);padding:12px;
      font-size:15px;margin-bottom:12px
    }
    .actions{display:flex;gap:8px;margin-bottom:12px}
    .btn{
      appearance:none;cursor:pointer;border:0;border-radius:14px;padding:12px 16px;font-weight:700
    }
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;flex:1}
    .btn.ghost{background:#0f0f14;border:1px solid #222739;color:var(--text)}
    .muted{color:var(--muted);font-size:12px;margin-top:6px}

    /* Upload de fichiers */
    .file-upload {
      margin-bottom:12px;
      position:relative;
    }

    .file-upload input[type="file"] {
      display:none;
    }

    .file-upload-label {
      display:flex;align-items:center;gap:8px;
      background:#0f0f14;border:1px solid #222739;border-radius:12px;
      color:var(--text);padding:10px 12px;cursor:pointer;
      font-size:14px;transition:all 0.2s ease;
    }

    .file-upload-label:hover {
      background:#1a1a1f;border-color:#4f46e5;
    }

    .file-upload-label.dragover {
      background:#1a1a1f;border-color:#22d3ee;border-style:dashed;
    }

    .file-info {
      background:#0f0f14;border:1px solid #222739;border-radius:8px;
      padding:8px 12px;margin-top:8px;font-size:12px;color:var(--muted);
    }

    .file-info.success { border-color:#10b981; color:#10b981; }
    .file-info.error { border-color:#ef4444; color:#ef4444; }

    @media (max-width:640px){
      .card { width:240px; height:320px; }
      .card:nth-child(1) { transform:rotate(-6deg) translateX(-40px); }
      .card:nth-child(3) { transform:rotate(6deg) translateX(40px); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- √âcran de s√©lection des cartes -->
    <div id="cardSelection" class="cards-container">
      <div class="card" data-interface="memoire">
        <div class="card-icon">üß†</div>
        <div class="card-title">M√©moire</div>
        <div class="card-desc">Acc√®s et gestion de vos m√©morisations organis√©es</div>
      </div>

      <div class="card" data-interface="business">
        <div class="card-icon">üíº</div>
        <div class="card-title">Business</div>
        <div class="card-desc">Gestion des affaires, projets et √©quipe</div>
      </div>

      <div class="card" data-interface="perso">
        <div class="card-icon">üë§</div>
        <div class="card-title">Perso</div>
        <div class="card-desc">Conversations personnelles et assistance</div>
      </div>
    </div>

    <!-- Interface s√©lectionn√©e -->
    <div id="interfaceContainer" class="interface-container" style="display:none;">
      <button class="back-btn" id="backBtn">‚Üê Retour</button>

      <div class="interface-header">
        <div class="interface-title" id="interfaceTitle">Interface</div>
        <div class="interface-subtitle" id="interfaceSubtitle">Description</div>
      </div>

      <div class="chat-container">
        <div class="scroll" id="chat">
          <!-- Messages affich√©s ici -->
        </div>

        <div class="panel">
          <!-- Upload de fichiers -->
          <div class="file-upload">
            <input type="file" id="fileInput" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.json,.xml,.csv,.zip,.rar" multiple>
            <label for="fileInput" class="file-upload-label" id="fileUploadLabel">
              <span>üìé</span>
              <span id="uploadText">Ajouter des fichiers (photos, docs, etc.)</span>
            </label>
            <div id="fileInfo" class="file-info" style="display:none;"></div>
          </div>

          <textarea id="userInput" placeholder="Tapez votre message..."></textarea>
          <div class="actions">
            <button class="btn ghost" id="clear">Effacer</button>
            <button class="btn primary" id="send">Envoyer</button>
          </div>
          <div class="muted" id="status"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiBase = window.location.hostname === 'localhost' ? 'http://localhost:5057' : '';
    const cardSelection = document.getElementById('cardSelection');
    const interfaceContainer = document.getElementById('interfaceContainer');
    const interfaceTitle = document.getElementById('interfaceTitle');
    const interfaceSubtitle = document.getElementById('interfaceSubtitle');
    const backBtn = document.getElementById('backBtn');
    const chatEl = document.getElementById('chat');
    const userInputEl = document.getElementById('userInput');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const statusEl = document.getElementById('status');

    // √âl√©ments pour l'upload de fichiers
    const fileInput = document.getElementById('fileInput');
    const fileUploadLabel = document.getElementById('fileUploadLabel');
    const uploadText = document.getElementById('uploadText');
    const fileInfo = document.getElementById('fileInfo');

    let currentInterface = null;

    // Gestion des fichiers
    function updateFileDisplay() {
      if (selectedFiles.length > 0) {
        const fileNames = selectedFiles.map(f => f.name).join(', ');
        uploadText.textContent = `${selectedFiles.length} fichier(s) s√©lectionn√©(s): ${fileNames}`;
        fileUploadLabel.style.borderColor = '#4f46e5';
      } else {
        uploadText.textContent = 'Ajouter des fichiers (photos, docs, etc.)';
        fileUploadLabel.style.borderColor = '#222739';
      }
    }

    function showFileInfo(message, type = 'info') {
      fileInfo.textContent = message;
      fileInfo.className = `file-info ${type}`;
      fileInfo.style.display = 'block';
      setTimeout(() => {
        fileInfo.style.display = 'none';
      }, 5000);
    }

    // Gestionnaire de fichiers s√©lectionn√©s
    fileInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      updateFileDisplay();
    });

    // Drag & drop
    let dragCounter = 0;

    fileUploadLabel.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragCounter++;
      fileUploadLabel.classList.add('dragover');
    });

    fileUploadLabel.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) {
        fileUploadLabel.classList.remove('dragover');
      }
    });

    fileUploadLabel.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    fileUploadLabel.addEventListener('drop', (e) => {
      e.preventDefault();
      dragCounter = 0;
      fileUploadLabel.classList.remove('dragover');

      const files = Array.from(e.dataTransfer.files);
      if (files.length > 0) {
        selectedFiles = files;
        updateFileDisplay();
        showFileInfo(`${files.length} fichier(s) d√©pos√©(s)`, 'success');
      }
    });

    // Upload des fichiers
    async function uploadFiles() {
      if (selectedFiles.length === 0) return;

      for (const file of selectedFiles) {
        try {
          showFileInfo(`Upload de ${file.name}...`, 'info');

          const formData = new FormData();
          formData.append('file', file);
          formData.append('session_id', 'web_interface');
          formData.append('auto_classify', 'true');

          const response = await fetch(apiBase + '/coach/smart_upload', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.auto_classified) {
            showFileInfo(`‚úÖ ${file.name} class√© automatiquement dans "${result.category}"`, 'success');
            addBubble(`üìÅ Fichier "${file.name}" upload√© et class√© dans "${result.category}" (confiance: ${(result.confidence * 100).toFixed(0)}%)`, 'ai');
          } else {
            showFileInfo(`‚ö†Ô∏è ${file.name} n√©cessite confirmation manuelle`, 'info');
            addBubble(result.message, 'ai');
          }

        } catch (error) {
          console.error('Erreur upload:', error);
          showFileInfo(`‚ùå Erreur upload de ${file.name}: ${error.message}`, 'error');
        }
      }

      // R√©initialiser apr√®s upload
      selectedFiles = [];
      fileInput.value = '';
      updateFileDisplay();
    }
    let selectedFiles = [];

    const interfaceConfig = {
      memoire: {
        title: 'üß† M√©moire',
        subtitle: 'Acc√®s et gestion de vos m√©morisations',
        placeholder: 'Ex: "montre-moi mes notes business", "cherche dans mes m√©moires"...'
      },
      business: {
        title: 'üíº Business',
        subtitle: 'Gestion des affaires et projets',
        placeholder: 'Ex: "rdv client xyz demain", "note pour l\'√©quipe"...'
      },
      perso: {
        title: 'üë§ Perso',
        subtitle: 'Conversations personnelles',
        placeholder: 'Ex: "aide-moi √† organiser ma journ√©e", "rappelle-moi de..."'
      }
    };

    // Gestion des cartes
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => {
        const interfaceType = card.dataset.interface;
        
        // Retirer la classe active de toutes les cartes
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        
        // Ajouter la classe active √† la carte cliqu√©e
        card.classList.add('active');
        
        // Petite pause pour l'animation avant de changer d'interface
        setTimeout(() => {
          selectInterface(interfaceType);
        }, 300);
      });
    });

    function selectInterface(type) {
      currentInterface = type;
      const config = interfaceConfig[type];

      // Mettre √† jour l'interface
      interfaceTitle.innerHTML = config.title;
      interfaceSubtitle.textContent = config.subtitle;
      userInputEl.placeholder = config.placeholder;

      // Masquer les cartes et afficher l'interface
      cardSelection.style.display = 'none';
      interfaceContainer.style.display = 'flex';

      // Effacer le chat pour une nouvelle session
      chatEl.innerHTML = '';
      userInputEl.value = '';
      statusEl.textContent = '';
    }

    // Bouton retour
    backBtn.addEventListener('click', () => {
      interfaceContainer.style.display = 'none';
      cardSelection.style.display = 'flex';
      currentInterface = null;
      
      // Retirer la classe active de toutes les cartes
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    });

    function addBubble(text, who){
      const b = document.createElement('div');
      b.className = 'bubble ' + who;
      b.textContent = text;
      chatEl.appendChild(b);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    clearBtn.onclick = () => {
      chatEl.innerHTML = '';
      userInputEl.value = '';
      statusEl.textContent = '';
      // R√©initialiser les fichiers
      selectedFiles = [];
      fileInput.value = '';
      updateFileDisplay();
      fileInfo.style.display = 'none';
    };

    async function converseWithCoach(){
      const query = userInputEl.value.trim();

      // Si on a des fichiers √† uploader, les traiter d'abord
      if (selectedFiles.length > 0) {
        await uploadFiles();
        if (!query) return; // Si seulement des fichiers, ne pas envoyer de message texte
      }

      if(!query) return;

      addBubble(query, 'me');
      userInputEl.value = '';

      statusEl.textContent = 'Le coach r√©fl√©chit...';
      const typing = document.createElement('div');
      typing.className = 'bubble ai pulse';
      typing.textContent = '‚Ä¶';
      chatEl.appendChild(typing);
      chatEl.scrollTop = chatEl.scrollHeight;

      try{
        // Adapter le message selon l'interface s√©lectionn√©e
        let messageToSend = query;
        let category = '';

        if(currentInterface === 'memoire') {
          messageToSend = `M√©moire: ${query}`;
          category = 'general';
        } else if(currentInterface === 'business') {
          messageToSend = `Business: ${query}`;
          category = 'business';
        } else if(currentInterface === 'perso') {
          messageToSend = `Personnel: ${query}`;
          category = 'personnel';
        }

        const r = await fetch(apiBase + '/coach/converse', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message: messageToSend, category: category})
        });

        if(!r.ok){
          throw new Error(`HTTP ${r.status}`);
        }
        const data = await r.json();
        typing.remove();
        statusEl.textContent = '';

        if(data.error){
          addBubble('Erreur: ' + data.error, 'ai');
        } else if(data.response){
          addBubble(data.response, 'ai');
        } else if(data.analysis){
          addBubble('Analyse: ' + data.analysis, 'ai');
        } else if(data.rephrased){
          addBubble('Rephras√©: ' + data.rephrased, 'ai');
        } else if(data.status){
          let result = `Statut: ${data.status}\n\n`;
          if(data.checks){
            for(const [key, value] of Object.entries(data.checks)){
              result += `${key}: ${value}\n`;
            }
          }
          addBubble(result, 'ai');
        } else {
          addBubble(JSON.stringify(data, null, 2), 'ai');
        }
      }catch(err){
        typing.remove();
        statusEl.textContent = '';
        addBubble('Erreur: ' + err.message, 'ai');
      }
    }

    sendBtn.onclick = () => {
      converseWithCoach();
    };

    userInputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        converseWithCoach();
      }
    });
  </script>
</body>
</html>